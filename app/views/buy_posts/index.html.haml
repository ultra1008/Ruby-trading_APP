= content_for :page_js do
  :javascript
    let map;
    function populateBuyPostsList(buy_posts) {
      console.log('populating sell posts list');

      $("#buyposts-maplist").empty();

      for (let i = 0; i < buy_posts.length; i++) {
        console.log(buy_posts[i].title);
        $("#buyposts-maplist").append(`
          <div>
            <div class="lta-card">
              <div class="lta-card-img-holder uk-flex uk-flex-center uk-flex-middle">
                <a href="${buy_posts[i].view_link}">
                  <img src="${buy_posts[i].upload_image}" alt="Image for ${buy_posts[i].title}" class="lta-card-img">
                </a>
              </div>

              <div class="lta-card-body">
                <a href="${sell_posts[i].view_link}" class="lta-card-title">${sell_posts[i].title}</a>
                <div class="lta-card-price-container uk-text-right">
                  <i class="fas fa-dollar-sign lta-card-buy-dollar"></i> &nbsp;&nbsp; ${sell_posts[i].price_low}&nbsp;&nbsp;-&nbsp;&nbsp;${sell_posts[i].price_high}
                </div>
              </div>
            </div>
          </div>
        `);
      }
    }
    function populateMarkers(buy_posts) {
      console.log('populating markers');
      let locations = [];
      let markers = [];
      for (let i = 0; i < buy_posts.length; i++) {
        let latlong = {lat: parseFloat(buy_posts[i].latitude), lng: parseFloat(buy_posts[i].longitude)};
        locations.push(latlong);
        let marker = new google.maps.Marker({position: latlong, map: map});
        let infoWindow = new google.maps.InfoWindow({
          content: `<b>${buy_posts[i].title}</b><br>By ${buy_posts[i].user}<br><img src="${buy_posts[i].upload_image}", style="width:50px;height:50px;" alt="NO IMG"/>`
        });
        marker.addListener('click', function () {
          infoWindow.open(map, marker);
        })
        markers.push(marker);
      }
      console.log('locations:', locations, 'markers:', markers);
    }
    function init_markers() {
      console.log('init_markers() called');
      Rails.ajax({
        type: "GET",
        url: '/buy_posts/map/all', // TODO: proper api conventions
        data: '',
        success: function(data) {
          console.log('success for getting all buy posts ' + data);
          populateBuyPostsList(data);
          populateMarkers(data);
        },
        error: function(error) {
          console.log('there was an error', error);
        }
      });
    }
    function initMap(element, lat, lng) {
      let myCoords = new google.maps.LatLng(lat, lng);
      let mapOptions = {
          center: myCoords,
          zoom: 8
      };
      map = new google.maps.Map(element, mapOptions);
      init_markers(map);
    }

= render 'partials/navbar'

-# Next row: Grayish title section
%div{:class => "uk-section lta-section-header"}
  .uk-container.uk-text-center
    %h1
      What people are
      %span.lta-text-blue
        buying


-# Next row: Interactive Google maps search
.uk-section.uk-padding-remove
  %div{:class => "", "uk-grid" => ""}

    -# Left half: Google map
    %div{:style => "", :class => "uk-width-1-2 uk-flex uk-flex-middle uk-flex-center", "uk-height-viewport" => "expand: true"}
      %div{:id => "gmap", :style => "width:100%; height:100%;"}
        :javascript
          initMap(document.getElementById('gmap'), "#{@geo_results_from_ip.first.coordinates.first}", "#{@geo_results_from_ip.first.coordinates.second}");

    -# Right half: Filtering and results in Card form
    %div{:style => "", :class => "uk-width-1-2 uk-padding-remove"}

      -# Search and price filtering section
      .uk-section.uk-padding-small
        .uk-text-center
          %div{:class => "uk-child-width-1-1@s", "uk-grid" => ""}
            %div
              .uk-flex
                %div{:class => "lta-form-input-box-left uk-flex uk-flex-middle uk-flex-center"}
                  %i.fas.fa-search.lta-browse-search-icon
                %div.uk-width-1-1
                  = text_field :search, 'query', class: 'lta-form-input lta-form-large uk-width-1-1', placeholder: "Search"
            %div
              = button_to 'Post a Request', new_buy_post_path, method: "get"

      %hr

      .uk-section.uk-padding-small
        %div{:id => "", :class => ""}

          -# TODO: div here for scrollability?
          %div{:class => "uk-panel uk-panel-scrollable uk-height-1-1", :style => "height:800px;"}

            %div{:id => "buyposts-maplist", :style => "", :class => "uk-grid-small uk-grid-match uk-child-width-1-1@m uk-child-width-1-2@l uk-child-width-1-3@xl", "uk-grid" => ""}
              .loader.loader--style5{:title => "4"}
                %svg#Layer_1{:height => "30px", :style => "enable-background:new 0 0 50 50;", :version => "1.1", :viewbox => "0 0 24 30", :width => "24px", :x => "0px", "xml:space" => "preserve", :xmlns => "http://www.w3.org/2000/svg", "xmlns:xlink" => "http://www.w3.org/1999/xlink", :y => "0px"}
                  %rect{:fill => "#333", :height => "10", :width => "4", :x => "0", :y => "0"}
                    %animatetransform{:attributename => "transform", :attributetype => "xml", :begin => "0", :dur => "0.6s", :repeatcount => "indefinite", :type => "translate", :values => "0 0; 0 20; 0 0"}
                  %rect{:fill => "#333", :height => "10", :width => "4", :x => "10", :y => "0"}
                    %animatetransform{:attributename => "transform", :attributetype => "xml", :begin => "0.2s", :dur => "0.6s", :repeatcount => "indefinite", :type => "translate", :values => "0 0; 0 20; 0 0"}
                  %rect{:fill => "#333", :height => "10", :width => "4", :x => "20", :y => "0"}
                    %animatetransform{:attributename => "transform", :attributetype => "xml", :begin => "0.4s", :dur => "0.6s", :repeatcount => "indefinite", :type => "translate", :values => "0 0; 0 20; 0 0"}

-#%div{:class => "uk-section"}
-#  %div{:class => "uk-container uk-container-small", "uk-height-viewport" => "expand: true"}
-#
-#    = button_to 'Post Your Request', new_buy_post_path, method: "get"
-#
-#    %hr
-#
-#    = form_tag buy_posts_path, :id => :category_form, :method => :get do
-#      Categories:
-#      - @all_categories.each do |category|
-#        -if category != nil
-#          = category
-#          = check_box_tag "categories[#{category}]", 1, session[:categories].include?(category)
-#        - else
-#          Uncategorized
-#          = check_box_tag "categories[nil]", 1, session[:categories].include?(category)
-#      = submit_tag 'Refresh'
-#
-#
-#      %table.uk-table
-#        %thead
-#          %tr
-#            - @columns.each do |column|
-#              - if column[:sort_allowed]
-#                - if session[:sorted_key] == column[:id].to_s
-#                  %th{:class => :hilite}
-#                    = link_to column[:name], buy_posts_path(:sorted => "nil"), id: column[:id].to_s + "_header"
-#                -else
-#                  %th= link_to column[:name], buy_posts_path(:sorted => column[:id]), id: column[:id].to_s + "_header"
-#              - else
-#                %th= column[:name]
-#        %tbody
-#          - @buy_posts.each do |post|
-#            %tr
-#              - @columns.each do |column|
-#                - if column[:id] == :title
-#                  %td= link_to post.title.presence || "(no title)", buy_post_path(post.id)
-#                - elsif column[:name] == :upload_image
-#                  - if post.upload_image.attached?
-#                    %td= image_tag(post.upload_image, size: '50x50')
-#                - else
-#                  %td= post.send column[:id]

= render 'partials/footer'
